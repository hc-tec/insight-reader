# 2.2 数据库设计

## MVP 特别说明

**MVP 阶段不使用数据库！**

所有数据都在前端内存和后端请求上下文中处理，实现真正的无状态极简架构。

---

## V2.0 数据库设计（未来引入）

当产品验证成功后，V2.0 将引入 SQLite 数据库来支持以下功能：
- 用户登录系统
- 阅读会话保存
- 洞察卡片收藏
- 暂存区功能

### 数据库选型：SQLite

**选型理由**:
- 零配置，无需独立部署
- 文件型数据库，易于备份
- 支持 ACID 事务
- 适合中小规模应用
- 支持全文搜索

---

## V2.0 核心数据模型

### ER 图

```
┌─────────────┐
│    Users    │
└──────┬──────┘
       │
       │ 1:N
       │
┌──────▼──────────┐
│   Sessions      │  (阅读会话)
└──────┬──────────┘
       │
       │ 1:N
       │
┌──────▼──────────┐
│   Insights      │  (洞察卡片)
└─────────────────┘
```

---

## V2.0 表结构设计

### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    hashed_password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    avatar_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,

    INDEX idx_users_email (email),
    INDEX idx_users_username (username)
);
```

**字段说明**:
- `id`: 主键
- `email`: 登录凭证
- `hashed_password`: bcrypt 哈希密码
- `last_login_at`: 用于统计活跃用户

---

### 2. 阅读会话表 (sessions)

```sql
CREATE TABLE sessions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    title VARCHAR(500),
    content TEXT NOT NULL,              -- 原文
    content_length INTEGER,
    language VARCHAR(10) DEFAULT 'zh',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_sessions_user_id (user_id),
    INDEX idx_sessions_created_at (created_at DESC)
);
```

**字段说明**:
- `content`: 用户粘贴的文章原文
- `title`: 自动提取或用户设置的标题
- `language`: 用于未来的多语言支持

---

### 3. 洞察卡片表 (insights)

```sql
CREATE TABLE insights (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    selected_text TEXT NOT NULL,        -- 用户选中的原文
    context TEXT,                       -- 上下文
    intent VARCHAR(20) NOT NULL,        -- explain | analyze | counter
    question TEXT,                      -- 用户自定义问题（可选）
    content TEXT NOT NULL,              -- AI 生成的洞察内容
    model_used VARCHAR(50),
    token_count INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_insights_session_id (session_id),
    INDEX idx_insights_user_id (user_id)
);
```

**字段说明**:
- `selected_text`: 记录用户划词选中的文本
- `intent`: 意图类型（解释/分析/反驳）
- `question`: 用户自定义追问（V2.0）
- `content`: AI 生成的完整洞察
- `model_used`: 记录使用的模型，用于成本分析

---

## V2.0 数据查询示例

### 获取用户的所有会话

```python
# 使用 SQLAlchemy (异步)
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

async def get_user_sessions(user_id: int, session: AsyncSession):
    stmt = select(Session).where(
        Session.user_id == user_id
    ).order_by(Session.created_at.desc()).limit(50)

    result = await session.execute(stmt)
    return result.scalars().all()
```

### 获取会话的所有洞察卡片

```python
async def get_session_insights(session_id: int, db: AsyncSession):
    stmt = select(Insight).where(
        Insight.session_id == session_id
    ).order_by(Insight.created_at.asc())

    result = await db.execute(stmt)
    return result.scalars().all()
```

---

## V2.0 迁移策略

### Alembic 配置

```python
# alembic/env.py
from app.models import Base, User, Session, Insight

target_metadata = Base.metadata
```

### 初始迁移

```bash
# 创建迁移
alembic revision --autogenerate -m "Initial V2.0 schema"

# 执行迁移
alembic upgrade head
```

---

## MVP → V2.0 迁移计划

### 数据迁移

MVP 阶段没有数据持久化，因此 V2.0 上线时：
1. ✅ 无需迁移历史数据
2. ✅ 用户从头开始注册
3. ✅ 清爽启动，无遗留问题

### 代码改动

```python
# MVP: 无数据库
@router.post("/insights/generate")
async def generate_insight(request: InsightRequest):
    # 直接调用 AI，不保存
    ...

# V2.0: 保存到数据库
@router.post("/insights/generate")
async def generate_insight(
    request: InsightRequest,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    insight_content = await ai_service.generate(...)

    # 保存洞察卡片
    insight = Insight(
        session_id=request.session_id,
        user_id=current_user.id,
        selected_text=request.selected_text,
        content=insight_content,
        ...
    )
    db.add(insight)
    await db.commit()

    return insight
```

---

## V3.0 扩展：知识库

### 新增表：知识卡片 (knowledge_cards)

```sql
CREATE TABLE knowledge_cards (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    source_insight_id INTEGER,          -- 来源洞察卡片（可选）
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    tags TEXT,                          -- JSON 数组: ["AI", "伦理"]
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (source_insight_id) REFERENCES insights(id) ON DELETE SET NULL,
    INDEX idx_knowledge_user_id (user_id)
);
```

### 新增表：卡片关联 (card_relationships)

```sql
CREATE TABLE card_relationships (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    from_card_id INTEGER NOT NULL,
    to_card_id INTEGER NOT NULL,
    relationship_type VARCHAR(20),      -- related | contradiction | supplement
    ai_explanation TEXT,                -- AI 解释两者关系
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (from_card_id) REFERENCES knowledge_cards(id) ON DELETE CASCADE,
    FOREIGN KEY (to_card_id) REFERENCES knowledge_cards(id) ON DELETE CASCADE,
    UNIQUE(from_card_id, to_card_id)
);
```

---

## 数据备份策略 (V2.0+)

### 自动备份脚本

```bash
#!/bin/bash
# backup_db.sh

DATE=$(date +%Y%m%d_%H%M%S)
DB_FILE="./data/insightreader.db"
BACKUP_DIR="./backups"

mkdir -p $BACKUP_DIR

# SQLite 在线备份
sqlite3 $DB_FILE ".backup '$BACKUP_DIR/db_$DATE.db'"

# 压缩
gzip "$BACKUP_DIR/db_$DATE.db"

# 删除 7 天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "Backup completed: db_$DATE.db.gz"
```

### 定时备份 (Cron)

```cron
# 每天凌晨 3 点备份
0 3 * * * /path/to/backup_db.sh >> /var/log/backup.log 2>&1
```

---

## 性能优化 (V2.0+)

### 索引优化

```sql
-- 复合索引：用户 + 创建时间
CREATE INDEX idx_sessions_user_created ON sessions(user_id, created_at DESC);

-- 洞察卡片的会话索引
CREATE INDEX idx_insights_session_created ON insights(session_id, created_at ASC);
```

### 查询优化

```python
# 使用 selectinload 避免 N+1 问题
from sqlalchemy.orm import selectinload

stmt = select(Session).options(
    selectinload(Session.insights)
).where(Session.id == session_id)
```

---

**文档版本**: 2.0（基于最新产品蓝图）
**最后更新**: 2025-01-19
**注意**: MVP 阶段本文档仅供参考，实际不使用数据库
