# 2.1 系统架构设计

## 1. 整体架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                       前端层 (Frontend)                       │
│                    Vue 3 + Nuxt 4 + Shadcn                   │
├─────────────────────────────────────────────────────────────┤
│  • 双栏阅读界面     • 划词选中交互    • 洞察卡片展示         │
│  • 文章内容输入     • 流式响应渲染                           │
└────────────┬────────────────────────────────────────────────┘
             │
             │ HTTPS (RESTful API + SSE)
             │
┌────────────▼────────────────────────────────────────────────┐
│                    后端应用层 (Backend)                       │
│                   Python 3.11+ + FastAPI                     │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   文本处理   │  │  上下文提取  │  │  意图识别    │      │
│  │ Text Parser  │  │Context Extract│ │Intent Detect │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │  AI 调用服务 │  │  流式响应    │                        │
│  │  AI Service  │  │ Stream Handler│                        │
│  └──────────────┘  └──────────────┘                        │
└────────────┬────────────────────────────────────────────────┘
             │
┌────────────▼────────────────────────────────────────────────┐
│                      外部服务层 (External)                    │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Claude API  │  │  Tavily AI   │  │   CDN        │      │
│  │   (AI推理)   │  │(搜索,V2.0)   │  │ (静态资源)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 MVP 架构特点

#### **极简化设计**
- **无数据库**: MVP 阶段所有数据在内存中处理，无持久化
- **无用户系统**: 无需登录，任何人都可以直接使用
- **无状态后端**: 每次请求独立处理，不依赖会话
- **前端主导**: 文章内容、句子分割结果都保存在前端状态

#### **核心流程**
```
用户粘贴文章 → 前端临时存储 → 用户划词选中 →
后端接收选中文本和上下文 → AI 生成洞察 → 流式返回前端
```

---

## 2. 技术栈详解

### 2.1 前端技术栈

#### **核心框架**
```json
{
  "vue": "^3.5.18",
  "nuxt": "^4.0.3",
  "vue-router": "^4.5.1"
}
```

**MVP 重点**:
- Nuxt 4 的 SSR 用于 SEO 优化（V2.0）
- MVP 阶段可以使用纯客户端渲染（SPA 模式）

#### **UI 组件库**
```json
{
  "shadcn-nuxt": "^2.2.0",
  "lucide-vue-next": "^0.541.0"
}
```

**使用的组件**:
- Button（智能预测按钮）
- Card（洞察卡片）
- Input/Textarea（文章输入）
- Popover（划词弹出框）
- ScrollArea（阅读区域）

#### **样式方案**
```json
{
  "tailwindcss": "^3.4.1",
  "tailwindcss-animate": "^1.0.7",
  "class-variance-authority": "^0.7.1"
}
```

#### **工具库**
```json
{
  "@vueuse/core": "^13.9.0",   // useTextSelection (划词)
  "clsx": "^2.1.1",
  "tailwind-merge": "^3.3.1"
}
```

**关键 Composable**:
- `useTextSelection`: 监听文本选中事件
- `useEventSource`: 处理 SSE 流式响应
- `useClipboard`: 处理粘贴操作

---

### 2.2 后端技术栈

#### **Web 框架**
```python
# requirements.txt (MVP 最小化)
fastapi==0.110.0
uvicorn[standard]==0.27.0
pydantic==2.6.0
sse-starlette==2.0.0  # SSE 支持
```

**MVP 特点**:
- 无需数据库相关依赖
- 无需认证相关依赖
- 专注于 AI 调用和文本处理

#### **文本处理**
```python
spacy==3.7.2  # 句子分割（后端备选）
# 注：MVP 阶段句子分割可以在前端用简单规则实现
```

#### **AI SDK**
```python
anthropic==0.18.0  # Claude API
```

**成本优化策略**:
```python
# 简单任务用 Haiku (便宜)
SIMPLE_MODEL = "claude-3-haiku-20240307"

# 复杂任务用 Sonnet (强大)
COMPLEX_MODEL = "claude-3-5-sonnet-20241022"
```

---

## 3. 模块设计

### 3.1 后端模块（极简版）

```
backend/
├── app/
│   ├── main.py                 # FastAPI 应用入口
│   ├── config.py               # 配置管理（API Key）
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   └── insights.py         # 洞察生成 API
│   │
│   ├── services/
│   │   ├── ai_service.py       # AI 调用服务
│   │   ├── context_extractor.py # 上下文提取
│   │   └── intent_detector.py  # 意图识别
│   │
│   ├── schemas/
│   │   └── insight.py          # Pydantic 模式
│   │
│   └── utils/
│       ├── prompt_templates.py # Prompt 模板
│       └── text_utils.py       # 文本工具
│
├── requirements.txt
├── .env.example
└── README.md
```

**极简原则**:
- 无 models 目录（无数据库）
- 无 db 目录（无数据库）
- 无 auth 相关（V2.0 引入）
- 所有逻辑在 services 层

### 3.2 前端模块

```
frontend/
├── app/
│   ├── components/
│   │   ├── ui/                 # Shadcn 组件
│   │   │   ├── button/
│   │   │   ├── card/
│   │   │   ├── popover/
│   │   │   └── scroll-area/
│   │   │
│   │   ├── reader/             # 阅读器组件
│   │   │   ├── ArticleInput.vue     # 文章输入框
│   │   │   ├── ReadingPane.vue      # 阅读面板
│   │   │   ├── TextSelection.vue    # 划词交互
│   │   │   ├── IntentButtons.vue    # 智能预测按钮
│   │   │   └── InsightCard.vue      # 洞察卡片
│   │   │
│   │   └── layout/
│   │       ├── Header.vue
│   │       └── ReaderLayout.vue     # 双栏布局
│   │
│   ├── composables/
│   │   ├── useArticle.ts       # 文章状态管理
│   │   ├── useSelection.ts     # 划词逻辑
│   │   ├── useInsight.ts       # 洞察生成
│   │   └── useStream.ts        # 流式响应处理
│   │
│   ├── pages/
│   │   └── index.vue           # 唯一页面（单页应用）
│   │
│   ├── utils/
│   │   ├── api.ts              # API 请求封装
│   │   ├── textParser.ts       # 前端句子分割
│   │   └── constants.ts
│   │
│   └── types/
│       ├── article.ts
│       └── insight.ts
│
├── nuxt.config.ts
└── package.json
```

---

## 4. 核心流程设计

### 4.1 文章输入与展示流程

```
用户在首页粘贴文章内容
    │
    ▼
┌─────────────────────────┐
│  前端: 简单句子分割     │
│  (按句号、问号、感叹号) │
│  或发送到后端用 spaCy   │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  前端状态保存:          │
│  {                      │
│    content: "原文",     │
│    sentences: [         │
│      {id, text, start,  │
│       end, context}     │
│    ]                    │
│  }                      │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  渲染双栏阅读界面       │
│  左侧: 原文             │
│  右侧: 空白（等待交互） │
└─────────────────────────┘
```

### 4.2 划词 → 洞察生成流程

```
用户在左侧原文划词选中
    │
    ▼
┌─────────────────────────────────┐
│  useTextSelection 检测到选中    │
│  获取:                          │
│  - selectedText: "康德的绝对命令"│
│  - start/end: 位置信息          │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│  前端: 提取上下文               │
│  找到选中文本所在句子           │
│  获取前后各 2 句作为上下文      │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│  前端: 意图识别（简单规则）     │
│  - 长度 < 5: 倾向"这是什么意思"  │
│  - 长度 > 20: 倾向"为什么这么说" │
│  - 包含"因为""所以": 逻辑分析   │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│  显示智能预测按钮 Popover:      │
│  • 这是什么意思？               │
│  • 作者为什么这么说？           │
│  • 有不同的看法吗？ (V2.0)      │
│  • [自定义输入框]               │
└────────┬────────────────────────┘
         │
         │ 用户点击某个按钮
         ▼
┌─────────────────────────────────┐
│  POST /api/v1/insights/generate │
│  Body: {                        │
│    selected_text: "...",        │
│    context: "...",              │
│    intent: "explain"            │
│  }                              │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  后端: ai_service.py                │
│  1. 选择合适的 Prompt 模板          │
│  2. 构建完整 Prompt:                │
│     - System: 角色设定              │
│     - User: 选中文本 + 上下文 + 问题│
│  3. 调用 Claude API (流式)          │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────┐
│  SSE 流式返回:          │
│  data: {"delta": "康"} │
│  data: {"delta": "德"}  │
│  data: {"delta": "的"}  │
│  ...                    │
│  data: {"done": true}   │
└────────┬────────────────┘
         │
         ▼
┌─────────────────────────┐
│  前端: 逐字渲染         │
│  在右侧洞察面板显示     │
│  打字机效果             │
└─────────────────────────┘
```

### 4.3 简化的句子分割（前端）

**MVP 阶段可以用简单规则**:
```typescript
// utils/textParser.ts
export function splitIntoSentences(text: string): Sentence[] {
  // 简单的正则分割
  const sentenceRegex = /[^.!?。！？]+[.!?。！？]+/g
  const matches = text.match(sentenceRegex) || []

  let currentPos = 0
  return matches.map((text, index) => {
    const start = currentPos
    const end = start + text.length
    currentPos = end

    return {
      id: index,
      text: text.trim(),
      start,
      end
    }
  })
}
```

**优点**:
- 无需后端 spaCy
- 响应更快
- 降低部署复杂度

**缺点**:
- 中英文混合可能不准确
- 复杂句式（引号、省略号）可能错误

**解决方案**: V2.0 引入后端 spaCy 优化

---

## 5. API 设计（极简版）

### 5.1 唯一的核心 API

**生成洞察 (流式)**

```http
POST /api/v1/insights/generate
Content-Type: application/json

{
  "selected_text": "康德的绝对命令",
  "context": "在伦理学中,康德的绝对命令是一个核心概念。它要求我们的行为准则能够成为普遍法则。这种道义论的观点与功利主义形成鲜明对比。",
  "intent": "explain",  // explain | analyze | counter
  "full_article": "完整文章内容"  // 可选，用于更丰富的上下文
}
```

**响应 (SSE)**:
```
Content-Type: text/event-stream

data: {"type": "start"}

data: {"type": "delta", "content": "康德"}

data: {"type": "delta", "content": "的绝对命令"}

data: {"type": "delta", "content": "（Categorical Imperative）"}

...

data: {"type": "complete", "full_content": "完整内容", "model": "claude-3-5-sonnet-20241022", "tokens": 256}
```

### 5.2 FastAPI 实现

```python
# app/api/insights.py
from fastapi import APIRouter
from fastapi.responses import StreamingResponse
from app.schemas.insight import InsightRequest
from app.services.ai_service import AIService

router = APIRouter(prefix="/insights", tags=["insights"])

@router.post("/generate")
async def generate_insight(request: InsightRequest):
    """流式生成洞察卡片"""
    ai_service = AIService()

    async def event_stream():
        yield "data: " + json.dumps({"type": "start"}) + "\n\n"

        async for chunk in ai_service.generate_insight_stream(
            selected_text=request.selected_text,
            context=request.context,
            intent=request.intent
        ):
            yield "data: " + json.dumps({"type": "delta", "content": chunk}) + "\n\n"

        yield "data: " + json.dumps({"type": "complete"}) + "\n\n"

    return StreamingResponse(
        event_stream(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive"
        }
    )
```

---

## 6. 性能优化策略

### 6.1 前端优化

#### **文本选中性能**
```typescript
// 使用 VueUse 的 useTextSelection
import { useTextSelection } from '@vueuse/core'

const { text, rects } = useTextSelection()

// 防抖，避免频繁触发
const debouncedText = refDebounced(text, 200)
```

#### **虚拟滚动（长文章）**
```vue
<!-- 仅在文章超过 1000 句时启用 -->
<VirtualScroller
  v-if="sentences.length > 1000"
  :items="sentences"
  :item-height="40"
>
  <template #default="{ item }">
    <SentenceItem :sentence="item" />
  </template>
</VirtualScroller>
```

#### **流式渲染优化**
```typescript
// 使用 requestAnimationFrame 批量更新
let pendingChunks: string[] = []

function appendChunk(chunk: string) {
  pendingChunks.push(chunk)

  if (!rafPending) {
    rafPending = true
    requestAnimationFrame(() => {
      content.value += pendingChunks.join('')
      pendingChunks = []
      rafPending = false
    })
  }
}
```

### 6.2 后端优化

#### **Prompt 长度控制**
```python
def extract_context(
    sentences: list[str],
    target_index: int,
    max_tokens: int = 500
) -> str:
    """智能提取上下文,控制在 max_tokens 以内"""
    context_before = sentences[max(0, target_index - 2):target_index]
    context_after = sentences[target_index + 1:target_index + 3]

    context = "\n".join(context_before + [sentences[target_index]] + context_after)

    # 简单的 token 估算（1 token ≈ 0.75 中文字符）
    if len(context) > max_tokens * 0.75:
        context = context[:int(max_tokens * 0.75)]

    return context
```

#### **模型选择策略**
```python
def select_model(intent: str, selected_text_length: int) -> str:
    """根据意图和文本长度选择模型"""
    if intent == "explain" and selected_text_length < 10:
        return "claude-3-haiku-20240307"  # 简单解释用便宜模型
    else:
        return "claude-3-5-sonnet-20241022"  # 复杂分析用强模型
```

---

## 7. 成本分析

### 7.1 MVP 成本估算

**假设**:
- 用户每篇文章划词 5 次
- 每次平均消耗 300 tokens (输入) + 500 tokens (输出)

**Claude 定价** (2025年1月):
- Haiku: $0.25 / 1M input, $1.25 / 1M output
- Sonnet: $3 / 1M input, $15 / 1M output

**单用户单篇文章成本**:
```
5 次划词 × (300 input + 500 output) tokens × $3/$15 per 1M
= 5 × (300 × $3/1M + 500 × $15/1M)
= 5 × ($0.0009 + $0.0075)
= 5 × $0.0084
= $0.042 (约 ¥0.3)
```

**优化后** (混合使用 Haiku):
```
3 次简单查询 × Haiku + 2 次复杂分析 × Sonnet
= 3 × $0.001 + 2 × $0.0084
= $0.003 + $0.0168
= $0.0198 (约 ¥0.14)
```

**结论**: 成本可控,且用户按需使用,不浪费

---

## 8. 部署架构

### 8.1 MVP 部署

```
┌─────────────────────────────┐
│  Vercel (前端)              │
│  - Nuxt 静态生成 (SSG)      │
│  - 或 SPA 模式              │
│  - 全球 CDN                 │
└─────────────┬───────────────┘
              │
              │ HTTPS
              ▼
┌─────────────────────────────┐
│  Railway / Render (后端)    │
│  - FastAPI + Uvicorn        │
│  - 自动扩展                 │
│  - 免费套餐足够 MVP         │
└─────────────────────────────┘
```

### 8.2 Docker 配置（最小化）

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 复制依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制代码
COPY ./app ./app

# 启动
CMD uvicorn app.main:app --host 0.0.0.0 --port 8000
```

---

## 9. MVP 验证指标

### 9.1 技术指标
- ✅ 划词响应 < 100ms
- ✅ AI 首字响应 < 2s
- ✅ 完整洞察生成 < 5s
- ✅ 前端 FPS > 55

### 9.2 体验指标
- ✅ 用户能理解如何使用（无需说明）
- ✅ 生成的洞察有价值（准确、易懂）
- ✅ 用户愿意多次使用
- ✅ 用户主动分享给他人

---

## 10. V2.0 升级路径

### 10.1 需要添加的组件

```
后端:
  + SQLite 数据库
  + JWT 认证
  + 用户注册/登录
  + 洞察卡片持久化
  + Tavily AI 集成（搜索）

前端:
  + Pinia 状态管理
  + 登录/注册页面
  + 卡片收藏功能
  + 暂存区界面
  + 个人中心
```

### 10.2 数据库表（V2.0）

```sql
-- 用户表
CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    email TEXT UNIQUE,
    username TEXT UNIQUE,
    hashed_password TEXT
);

-- 会话表（保存阅读会话）
CREATE TABLE sessions (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    article_title TEXT,
    article_content TEXT,
    created_at TIMESTAMP
);

-- 洞察卡片表
CREATE TABLE insights (
    id INTEGER PRIMARY KEY,
    session_id INTEGER,
    selected_text TEXT,
    intent TEXT,
    content TEXT,
    created_at TIMESTAMP
);
```

---

**文档版本**: 2.0（基于最新产品蓝图）
**最后更新**: 2025-01-19
